stages:
  - build
  - validate
  - deploy

.before_script_template: &before_script_template
  before_script:
    - |
      if [[ "$ACCOUNT_OWNER" == "revyrie" ]]; then
        export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_REVYRIE
        export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_REVYRIE
        export AWS_DEFAULT_REGION=$REGION_REVYRIE
        export AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID_REVYRIE
      else
        export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID_CLIENT
        export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY_CLIENT
        export AWS_DEFAULT_REGION=$REGION_CLIENT
        export AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID_CLIENT
      fi

.build_template: &build_template
  <<: *before_script_template
  image: docker:24.0.5
  services:
    - name: docker:24.0.5-dind
      alias: docker
  stage: build
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKER_DRIVER: overlay2
  script:
    - echo "ðŸ” Logging in to ECR"
    - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
    - export IMAGE_TAG="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$ECR_REPO_NAME:$CI_COMMIT_SHORT_SHA"
    - docker build -t $IMAGE_TAG .
    - docker push $IMAGE_TAG
    - echo "IMAGE_TAG=$IMAGE_TAG" >> image.env
  artifacts:
    reports:
      dotenv: image.env
 
.validate_template: &validate_template
  <<: *before_script_template
  image: amazon/aws-cli:2
  stage: validate
  script:
    - test -n "$DEPLOY_ENV" || (echo "âŒ DEPLOY_ENV not set!" && exit 1)
    - echo "ðŸ” Validating ECS task def for environment $DEPLOY_ENV"
    - echo "Using file .devops/task-def.$DEPLOY_ENV.json"
    - ls -l .devops/task-def.$DEPLOY_ENV.json || (echo "âŒ File not found!" && exit 1)
    - aws ecs register-task-definition --cli-input-json file://.devops/task-def.$DEPLOY_ENV.json --dry-run

.deploy_template: &deploy_template
  <<: *before_script_template
  image: amazon/aws-cli:2
  stage: deploy
  script:
    - test -n "$DEPLOY_ENV" || (echo "âŒ DEPLOY_ENV not set!" && exit 1)
    - echo "ðŸš€ Deploying to ECS - $DEPLOY_ENV"
    - echo "Replacing <IMAGE_URI> with $IMAGE_TAG in .devops/task-def.$DEPLOY_ENV.json"
    - sed -i "s|<IMAGE_URI>|$IMAGE_TAG|g" .devops/task-def.$DEPLOY_ENV.json
    - aws ecs register-task-definition --cli-input-json file://.devops/task-def.$DEPLOY_ENV.json
    - aws ecs update-service --cluster $CLUSTER_NAME --service $ECS_SERVICE_NAME --force-new-deployment

# === ENV: DEV ===
build_dev:
  <<: *build_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: dev
    ECR_REPO_NAME: myapp-dev
  only: [dev]

validate_dev:
  <<: *validate_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: dev
  needs: [build_dev]
  only: [dev]

deploy_dev:
  <<: *deploy_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: dev
    ECS_SERVICE_NAME: myapp-dev
    CLUSTER_NAME: revyrie-cluster
  needs: [build_dev, validate_dev]
  only: [dev]

# === ENV: QA ===
build_qa:
  <<: *build_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: qa
    ECR_REPO_NAME: myapp-qa
  only: [qa]

validate_qa:
  <<: *validate_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: qa
  needs: [build_qa]
  only: [qa]

deploy_qa:
  <<: *deploy_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: qa
    ECS_SERVICE_NAME: myapp-qa
    CLUSTER_NAME: revyrie-cluster
  needs: [build_qa, validate_qa]
  only: [qa]

# === ENV: BETA ===
build_beta:
  <<: *build_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: beta
    ECR_REPO_NAME: myapp-beta
  only: [beta]

validate_beta:
  <<: *validate_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: beta
  needs: [build_beta]
  only: [beta]

deploy_beta:
  <<: *deploy_template
  variables:
    ACCOUNT_OWNER: revyrie
    DEPLOY_ENV: beta
    ECS_SERVICE_NAME: myapp-beta
    CLUSTER_NAME: revyrie-cluster
  needs: [build_beta, validate_beta]
  only: [beta]

# === ENV: STAG ===
build_stag:
  <<: *build_template
  variables:
    ACCOUNT_OWNER: client
    DEPLOY_ENV: stag
    ECR_REPO_NAME: myapp-stag
  only: [stag]

validate_stag:
  <<: *validate_template
  variables:
    ACCOUNT_OWNER: client
    DEPLOY_ENV: stag
  needs: [build_stag]
  only: [stag]

deploy_stag:
  <<: *deploy_template
  variables:
    ACCOUNT_OWNER: client
    DEPLOY_ENV: stag
    ECS_SERVICE_NAME: myapp-stag
    CLUSTER_NAME: client-cluster
  needs: [build_stag, validate_stag]
  only: [stag]

# === ENV: PROD ===
build_prod:
  <<: *build_template
  variables:
    ACCOUNT_OWNER: client
    DEPLOY_ENV: prod
    ECR_REPO_NAME: myapp-prod
  only: [prod]

validate_prod:
  <<: *validate_template
  variables:
    ACCOUNT_OWNER: client
    DEPLOY_ENV: prod
  needs: [build_prod]
  only: [prod]

deploy_prod:
  <<: *deploy_template
  variables:
    ACCOUNT_OWNER: client
    DEPLOY_ENV: prod
    ECS_SERVICE_NAME: myapp-prod
    CLUSTER_NAME: client-cluster
  needs: [build_prod, validate_prod]
  only: [prod]
